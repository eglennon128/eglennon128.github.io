(()=>{(()=>{"use strict";(function(){let f=Array.from(document.querySelectorAll(".gis-map"));if(!f.length)return;function p(){return typeof window.L!="undefined"}function s(t){if(!t)return[37.7749,-122.4194];let e=t.split(",").map(i=>parseFloat(i.trim()));return e.length===2&&e.every(i=>Number.isFinite(i))?[e[0],e[1]]:[37.7749,-122.4194]}function l(t,e){if(t){if(t.setOpacity)try{t.setOpacity(e)}catch{}if(t.setStyle)try{t.setStyle({opacity:e,fillOpacity:Math.max(0,Math.min(1,e*.8))})}catch{}if(t.eachLayer)try{t.eachLayer(i=>l(i,e))}catch{}}}function h(t,e,i=240){if(!e)return;l(e,0),t.hasLayer(e)||e.addTo(t);let a=performance.now();function r(n){let o=Math.min(1,(n-a)/i);l(e,o),o<1&&requestAnimationFrame(r)}requestAnimationFrame(r)}function g(t,e,i=240,a){if(!e||!t.hasLayer(e)){a&&a();return}let r=performance.now();function n(o){let c=Math.min(1,(o-r)/i);if(l(e,1-c),c<1)requestAnimationFrame(n);else{try{t.removeLayer(e)}catch{}a&&a()}}requestAnimationFrame(n)}function y(t){if(!p()){console.warn("Leaflet not available");return}if(t._map)return;let e=s(t.getAttribute("data-center")),i=parseInt(t.getAttribute("data-zoom")||"13",10),a=(t.getAttribute("data-kind")||"").toLowerCase(),r=L.map(t,{zoomControl:!0,scrollWheelZoom:!0}).setView(e,i);if(t._map=r,t._defaultView={center:e,zoom:i},t._overlays={},L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(r).on("tileerror",()=>{console.warn("Map tiles failed to load. Check network or tile URL."),t.style.boxShadow="inset 0 0 0 2px rgba(239,68,68,0.35)"}),a==="ortho"||a==="remote-sensing"){let o=L.latLngBounds([e[0]-.02,e[1]-.03],[e[0]+.02,e[1]+.03]),c=L.rectangle(o,{color:"#16a34a",weight:1,fillColor:"#22c55e",fillOpacity:.35}),u=L.rectangle(o,{color:"#ef4444",weight:1,fillColor:"#ef4444",fillOpacity:.3});t._overlays.ndvi=c,t._overlays.thermal=u}if(a==="photogrammetry"){let o=L.polygon([[e[0]+.01,e[1]-.02],[e[0]+.02,e[1]+.01],[e[0]-.01,e[1]+.02],[e[0]-.02,e[1]-.01]],{color:"#3b82f6",weight:2,fillColor:"#60a5fa",fillOpacity:.15}),c=L.layerGroup([L.marker([e[0]+.005,e[1]+.005]).bindTooltip("GCP 1"),L.marker([e[0]-.006,e[1]+.01]).bindTooltip("GCP 2"),L.marker([e[0]-.003,e[1]-.012]).bindTooltip("GCP 3")]);t._overlays.extent=o.addTo(r),t._overlays.gcp=c}document.querySelectorAll(`[data-for="#${t.id}"]`).forEach(o=>{let c=o.getAttribute("data-layer"),u=o.getAttribute("data-action");c&&o.addEventListener("click",()=>{o.parentElement.querySelectorAll("[data-layer]").forEach(A=>A.classList.remove("is-active")),o.classList.add("is-active");let d=t._overlays[c],v=t._currentOverlay;v&&v!==d?g(r,v,200,()=>{t._currentOverlay=d||null,d&&h(r,d,220)}):(t._currentOverlay=d||null,d&&h(r,d,220))}),u==="reset-view"&&o.addEventListener("click",()=>{r.setView(t._defaultView.center,t._defaultView.zoom,{animate:!0})})})}if("IntersectionObserver"in window){let t=new IntersectionObserver((e,i)=>{e.forEach(a=>{a.isIntersecting&&(y(a.target),i.unobserve(a.target))})},{threshold:.2,rootMargin:"0px 0px -8% 0px"});f.forEach(e=>t.observe(e))}else f.forEach(t=>y(t));let m=document.querySelector('[data-filter-scope="gis"]');if(m){let i=function(r){t.forEach(n=>n.classList.remove("is-active")),r.classList.add("is-active")},a=function(r){e.forEach(n=>{let o=(n.getAttribute("data-type")||"").toLowerCase();if(r==="all"||r===o)n.style.display="",requestAnimationFrame(()=>{n.classList.remove("hidden-by-filter"),n.removeAttribute("aria-hidden")});else if(!n.classList.contains("hidden-by-filter")){n.classList.add("hidden-by-filter");let u=w=>{w.propertyName==="opacity"&&(n.style.display="none",n.setAttribute("aria-hidden","true"),n.removeEventListener("transitionend",u))};n.addEventListener("transitionend",u)}})},t=Array.from(m.querySelectorAll("[data-filter]")),e=Array.from(document.querySelectorAll(".map-card"));t.forEach(r=>r.addEventListener("click",()=>{i(r),a(r.getAttribute("data-filter"))}))}})(),(function(){let f=document.querySelector("[data-cesium-toggle]");if(!f)return;let p=f.getAttribute("data-for"),s=p?document.querySelector(p):null;if(!s)return;let l=null;function h(){if(l)return l;if(typeof window.Cesium=="undefined")return console.warn("CesiumJS not available (offline or blocked)."),null;let{Cesium:m}=window;return l=new m.Viewer(s,{imageryProvider:new m.UrlTemplateImageryProvider({url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"}),terrain:void 0,animation:!1,timeline:!1,sceneModePicker:!1,baseLayerPicker:!1}),l}function g(){s.hidden=!1,s.setAttribute("aria-hidden","false"),s.scrollIntoView({behavior:"smooth",block:"center"})}function y(){s.hidden=!0,s.setAttribute("aria-hidden","true")}f.addEventListener("click",()=>{s.hidden?(g(),h()):y()})})()})();})();
